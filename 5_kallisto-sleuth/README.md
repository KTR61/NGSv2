# kallisto、sleuthを用いた処理  
## kallisto  
- kallisto用のインデックス作成    
  - ```kallisto index --index=~/Documents/expression/ref/kallisto.idx ~/Documents/expression/ref/Homo_sapiens.GRCh38.cdna.all.fa.gz```  
  - 完了すると~/Documents/expression/ref ディレクトリ内に kallisto.idx というインデックスファイルが作成される。  
- kallisto [公式ページ](https://github.com/pachterlab/kallisto-transcriptome-indices/releases)からインデックスファイルをダウンロードした場合は下記のコマンドで解凍  
  - ```gunzip Homo_sapiens.GRCh38.cdna.all.release-94_k31.idx.gz```  
- 転写産物の定量  
  - kallistoの出力先ディレクトリを作成する  
  - ```mkdir -p ~/Documents/expression/kallisto```  
  - ```cd ~/Documents/expression/kallisto```  
  - 転写産物の定量（コマンド例）  
  - ```kallisto quant --index=../ref/kallisto.idx --output-dir=SRR******* --bootstrap-samples=100 --threads=2 ../seq/SRR*******_1.fastq.gz  ../seq/SRR*******_2.fastq.gz```  
    - --index でインデックスファイルを指定  
    - インデックスファイルの名前は必要に応じて変更  
    - --output-dir では出力先のディレクトリ名を指定（あらかじめディレクトリを準備する必要はない）  
    - --bootstrap-samples は転写産物の推定値の信頼性を評価するためのブートストラップサンプリングの回数を指定  
    - --threadsはスレッド数を指定  
    - --pseudobamオプションを付けるとpseudoalignmentの結果をBAMファイルとして保存することができ、別の解析ソフトに読み込ませることが可能になる  
  - 多サンプル処理する場合は下記のようにするとコマンド入力のミスを少なくできる
    - ```cat ../seq/run_ids | while read sample; do echo processing ${sample}; kallisto quant --index=../ref/kallisto.idx --output-dir=${sample} --bootstrap-samples=100 --threads=4  ../seq/${sample}_1.fastq.gz  ../seq/${sample}_2.fastq.gz; done; echo finished```  
    - 最後に finished と表示されれば終了  
  - 全サンプルの出力結果を確認するためには以下のコマンドを実行する  
    - ```find ~/Documents/expression/kallisto -type f```  
## Sleuth
    - ```~/Documents/expression/tools/STAR-2.7.0a/bin/MacOSX_x86_64/STAR --runMode genomeGenerate --genomeDir ~/Documents/expression/ref/STAR_reference --genomeFastaFiles ~/Documents/expression/ref/Homo_sapiens.GRCh38.dna.primary_assembly.fa --sjdbGTFfile ~/Documents/expression/ref/Homo_sapiens.GRCh38.95.gtf```  
- マッピング  
  - マッピングしたファイルを保管するディレクトリを作成  
    - ```mkdir -p ~/Documents/expression/STAR```  
    - ```cd ~/Documents/expression/STAR```  
  - １サンプル分のマッピング（SRR\*\*\*\*\*\*\*には実在するSRR IDを記入する）
    - ```~/Documents/expression/tools/STAR-2.7.0a/bin/MacOSX_x86_64/STAR --runMode alignReads --genomeDir ../ref/STAR_reference --readFilesCommand gunzip -c --readFilesIn ../seq/SRR*******_1.fastq.gz  ../seq/SRR*******_2.fastq.gz --outSAMtype BAM SortedByCoordinate --runThreadN 4 --outFileNamePrefix SRR1550989 --quantMode TranscriptomeSAM```  
  - 多サンプルのマッピング
    - ```for sample in `ls ../seq/*fastq.gz | xargs basename | cut -f1 -d"_" | uniq`; do echo mapping:${sample}; ../tools/STAR-2.7.0a/bin/MacOSX_x86_64/STAR --runMode alignReads --genomeDir ../ref/STAR_reference --readFilesCommand gunzip -c  --readFilesIn ../seq/${sample}_1.fastq.gz ../seq/${sample}_2.fastq.gz --outSAMtype BAM SortedByCoordinate --runThreadN 4 --quantMode TranscriptomeSAM --outFileNamePrefix ${sample};done; echo finished```  
## RSEM
- source codeを ~/Documents/expression/tools にダウンロードしたのちファイルを解凍
  - ```cd ~/Documents/expression/tools```  
  - ```tar -zxvf RSEM-1.3.1.tar.gz```  
- インデックスの作成  
  - インデックス保存用のディレクトリを作成  
    - ```mkdir ~/Documents/expression/ref/RSEM_reference```  
    - ```cd ~/Documents/expression/ref/RSEM_reference```  
  - インデックス作成
    - ```../tools/RSEM-1.3.1/bin/rsem-prepare-reference --num-threads 4 --gtf Homo_sapiens.GRCh38.95.gtf Homo_sapiens.GRCh38.dna.primary_assembly.fa RSEM_reference/RSEM_reference```  
- 発現量定量
  - STAR解析結果が保管されているディレクトリに移動
    - ```cd ~/Documents/expression/STAR```  
  - 発現量定量
    - ```for sample in `ls ../seq/*fastq.gz | xargs basename | cut -f1 -d"_" | uniq`; do ../tools/RSEM-1.3.1/rsem-calculate-expression --num-threads 4 --paired-end --bam ${sample}Aligned.toTranscriptome.out.bam ../ref/RSEM_reference/RSEM_reference ${sample}; done```  
